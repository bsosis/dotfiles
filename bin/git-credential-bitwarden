#!/bin/bash
# Git credential helper that uses GH_TOKEN from environment (set by load_secrets)
# Usage: git config --global credential.helper "/path/to/git-credential-bitwarden"

set -euo pipefail

case "${1:-}" in
    get)
        # Read the input to determine what host we're authenticating to
        host=""
        protocol=""
        while IFS='=' read -r key value; do
            case "$key" in
                host) host="$value" ;;
                protocol) protocol="$value" ;;
            esac
        done

        # Only handle github.com over https
        if [[ "$host" == "github.com" && "$protocol" == "https" ]]; then
            if [[ -n "${GH_TOKEN:-}" ]]; then
                echo "protocol=https"
                echo "host=github.com"
                echo "username=x-access-token"
                echo "password=$GH_TOKEN"
            fi
        fi
        ;;
    store|erase)
        # We don't support storing or erasing credentials
        ;;
esac
